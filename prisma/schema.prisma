// Omkar Hotel - Database Schema
// Production-ready schema for hotel booking system with PMS integration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// Room Types
enum RoomType {
  DELUXE
  SUITE
  FAMILY
  STANDARD
}

// Room Status
enum RoomStatus {
  AVAILABLE
  OCCUPIED
  CLEANING
  MAINTENANCE
  OUT_OF_ORDER
}

// Booking Status
enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

// Payment Status
enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

// Rate Type
enum RateType {
  BASE
  WEEKEND
  SEASONAL
  SPECIAL
}

// PMS Sync Direction
enum SyncDirection {
  INBOUND  // From PMS to Website
  OUTBOUND // From Website to PMS
}

// PMS Sync Status
enum SyncStatus {
  SUCCESS
  FAILED
  PENDING
  RETRY
}

// ============= CORE TABLES =============

model Room {
  id          String      @id @default(uuid())
  roomNumber  String      @unique @map("room_number")
  type        RoomType
  capacity    Int
  amenities   Json        @default("[]") // Array of amenities
  description String?
  images      Json        @default("[]") // Array of image URLs
  status      RoomStatus  @default(AVAILABLE)
  floor       Int?
  size        Int?        // Size in sq ft
  
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  // Relations
  rates       RoomRate[]
  bookings    Booking[]
  blocks      RoomBlock[]
  
  @@map("rooms")
}

model RoomRate {
  id                String    @id @default(uuid())
  roomId            String    @map("room_id")
  baseRate          Decimal   @map("base_rate") @db.Decimal(10, 2)
  effectiveFrom     DateTime  @map("effective_from") @db.Date
  effectiveTo       DateTime? @map("effective_to") @db.Date
  rateType          RateType  @default(BASE) @map("rate_type")
  weekendMultiplier Decimal   @default(1.0) @map("weekend_multiplier") @db.Decimal(3, 2)
  description       String?
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  
  // Relations
  room              Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@index([roomId, effectiveFrom, effectiveTo])
  @@map("room_rates")
}

model Guest {
  id        String    @id @default(uuid())
  email     String    @unique
  fullName  String    @map("full_name")
  phone     String
  address   Json?     // {street, city, state, country, zip}
  idProof   Json?     @map("id_proof") // {type, number, image_url}
  
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  
  // Relations
  bookings  Booking[]
  
  @@map("guests")
}

model Booking {
  id               String         @id @default(uuid())
  bookingReference String         @unique @map("booking_reference") // e.g., OMK-20250101-ABCD
  guestId          String         @map("guest_id")
  roomId           String         @map("room_id")
  checkIn          DateTime       @map("check_in") @db.Date
  checkOut         DateTime       @map("check_out") @db.Date
  numberOfGuests   Int            @default(1) @map("number_of_guests")
  totalAmount      Decimal        @map("total_amount") @db.Decimal(10, 2)
  taxAmount        Decimal        @default(0) @map("tax_amount") @db.Decimal(10, 2)
  discountAmount   Decimal        @default(0) @map("discount_amount") @db.Decimal(10, 2)
  status           BookingStatus  @default(PENDING)
  specialRequests  String?        @map("special_requests") @db.Text
  pmsBookingId     String?        @unique @map("pms_booking_id") // External PMS reference
  
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  
  // Relations
  guest            Guest          @relation(fields: [guestId], references: [id], onDelete: Restrict)
  room             Room           @relation(fields: [roomId], references: [id], onDelete: Restrict)
  addons           BookingAddon[]
  transaction      Transaction?
  pmsLogs          PmsLog[]
  
  @@index([checkIn, checkOut])
  @@index([roomId, checkIn, checkOut])
  @@index([status])
  @@map("bookings")
}

model RoomBlock {
  id         String   @id @default(uuid())
  roomId     String   @map("room_id")
  startDate  DateTime @map("start_date") @db.Date
  endDate    DateTime @map("end_date") @db.Date
  reason     String?

  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  room       Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId, startDate, endDate])
  @@map("room_blocks")
}

model BookingAddon {
  id        String   @id @default(uuid())
  bookingId String   @map("booking_id")
  addonType String   @map("addon_type") // BREAKFAST, SPA, PICKUP, etc.
  name      String
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10, 2)
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  @@map("booking_addons")
}

model Transaction {
  id               String        @id @default(uuid())
  bookingId        String        @unique @map("booking_id")
  paymentGatewayId String        @unique @map("payment_gateway_id") // Razorpay/Stripe ID
  amount           Decimal       @db.Decimal(10, 2)
  currency         String        @default("INR")
  status           PaymentStatus @default(PENDING)
  paymentMethod    String?       @map("payment_method") // UPI, Card, NetBanking, etc.
  metadata         Json?         // Additional payment gateway data
  refundAmount     Decimal       @default(0) @map("refund_amount") @db.Decimal(10, 2)
  refundedAt       DateTime?     @map("refunded_at")
  
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  
  // Relations
  booking          Booking       @relation(fields: [bookingId], references: [id], onDelete: Restrict)
  
  @@map("transactions")
}

model PmsLog {
  id        String        @id @default(uuid())
  bookingId String?       @map("booking_id") // Nullable for inventory sync logs
  action    String        // SYNC_INVENTORY, PUSH_BOOKING, CANCEL_BOOKING, etc.
  direction SyncDirection
  status    SyncStatus
  payload   Json          // Request/Response data
  errorMsg  String?       @map("error_msg") @db.Text
  
  createdAt DateTime      @default(now()) @map("created_at")
  
  // Relations
  booking   Booking?      @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  
  @@index([createdAt])
  @@index([action, status])
  @@map("pms_logs")
}

// ============= ADMIN & CONFIGURATION =============

model AdminUser {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String   @map("full_name")
  role         String   @default("ADMIN") // ADMIN, MANAGER, STAFF
  isActive     Boolean  @default(true) @map("is_active")
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@map("admin_users")
}

model HotelConfig {
  id                  String   @id @default(uuid())
  key                 String   @unique
  value               Json     // Flexible config storage
  description         String?
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("hotel_config")
}
